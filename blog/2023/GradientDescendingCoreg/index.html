<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>NuthKaab Coreg vs Gradient Descending Coreg | Zhihao LIU</title> <meta name="author" content="Zhihao LIU"/> <meta name="description" content="I just created the best ever coreg tool?"/> <meta name="keywords" content="geoscience, geospatial data science, geomorphology, seismic, energy transition, marathon"/> <meta property="og:site_name" content="Zhihao LIU"/> <meta property="og:type" content="website"/> <meta property="og:title" content="Zhihao LIU | NuthKaab Coreg vs Gradient Descending Coreg"/> <meta property="og:url" content="https://zhihaol.eu.org/blog/2023/GradientDescendingCoreg/"/> <meta property="og:description" content="I just created the best ever coreg tool?"/> <meta property="og:locale" content="en"/> <meta name="twitter:card" content="summary"/> <meta name="twitter:title" content="NuthKaab Coreg vs Gradient Descending Coreg"/> <meta name="twitter:description" content="I just created the best ever coreg tool?"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ““</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://zhihaol.eu.org/blog/2023/GradientDescendingCoreg/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://zhihaol.eu.org/"><span class="font-weight-bold">ZhihaoÂ </span>LIU</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">NuthKaab Coreg vs Gradient Descending Coreg</h1> <p class="post-meta">January 2, 2023â€¢ Zhihao</p> <p class="post-tags"> <a href="https://zhihaol.eu.org/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a> Â  Â· Â  <a href="https://zhihaol.eu.org/blog/tag/notes"> <i class="fas fa-hashtag fa-sm"></i> notes</a> Â  Â  Â· Â  <a href="https://zhihaol.eu.org/blog/category/geodata"> <i class="fas fa-tag fa-sm"></i> geodata</a> Â  <a href="https://zhihaol.eu.org/blog/category/datascience"> <i class="fas fa-tag fa-sm"></i> datascience</a> Â  </p> </header> <article class="post-content"> <p>DEM coregistration is an important step in improving the quality of a DEM by eliminating horizontal shift and vertical bias. However, it can be time-consuming, particularly for large datasets and global applications such as the SNOWDEPTH project.</p> <p>In the past few months, I have found that the implementation of NuthKaab coregistration in xDEM is not fast enough for ICESat-2 datasets. As a result, I have developed a new method called â€˜Gradient Descending Coregistration,â€™ which works similarly to ICP (Iterative Closest Point) but is significantly faster. I am eager to receive professional input to make this method more robust and useful for others.</p> <p>The purpose of this section is:</p> <ul> <li>to compare the performance of NuthKaab coregistration and â€˜Gradient Descending Coregistrationâ€™ on ICESat-2 datasets.</li> <li>In addition, I will consider the possibility of extending â€˜Gradient Descending Coregistrationâ€™ to other scenarios beyond ICESat-2 point coregistration.</li> <li>Finally, I will explore the footprint problem: should I treat the point measurements of ICESat-2 as a footprint (zonal statistics) or using point interpolation.</li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">geopandas</span> <span class="k">as</span> <span class="n">gpd</span>
<span class="kn">import</span> <span class="n">xdem</span>
<span class="kn">import</span> <span class="n">xdem_pt</span>
<span class="kn">import</span> <span class="n">importlib</span>
<span class="kn">import</span> <span class="n">pyproj</span>
<span class="kn">from</span> <span class="n">xsnow.godh</span> <span class="kn">import</span> <span class="n">load_gdf</span><span class="p">,</span><span class="n">best_shift_px</span><span class="p">,</span><span class="n">get_dh_by_shift_px_gdf</span><span class="p">,</span><span class="n">get_dh_by_shift_px_dem</span><span class="p">,</span><span class="n">get_dh_dem</span><span class="p">,</span><span class="n">dem_difference_plot</span><span class="p">,</span> <span class="n">best_footprint</span><span class="p">,</span><span class="n">get_dh_by_footprint</span>
<span class="kn">from</span> <span class="n">xsnow.misc</span> <span class="kn">import</span> <span class="n">df_from_dem</span>
<span class="kn">from</span> <span class="n">xsnow.goplot</span> <span class="kn">import</span> <span class="n">final_histogram</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Loading the dataset.
</span>
<span class="c1"># 1 ICESat-2 snow free measurements.
</span><span class="n">sf_gdf</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">snow_free_land_gdf.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sh">'</span><span class="se">\t</span><span class="sh">'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># 2 DTM 10 exmaple (10 m Norway DTM-10)
</span><span class="n">fid_dtm10</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">\\hypatia.uio.no\lh-mn-geofag-felles\projects\snowdepth\data\DEM\Norway\DTM10_UTM33\6603_3_10m_z33.tif</span><span class="sh">'</span>
<span class="n">dtm_10_</span> <span class="o">=</span> <span class="n">xdem</span><span class="p">.</span><span class="nc">DEM</span><span class="p">(</span><span class="n">fid_dtm10</span><span class="p">).</span><span class="nf">reproject</span><span class="p">(</span><span class="n">dst_crs</span><span class="o">=</span><span class="n">pyproj</span><span class="p">.</span><span class="nc">CRS</span><span class="p">(</span><span class="mi">32633</span><span class="p">),</span><span class="n">dst_res</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">dtm_10</span> <span class="o">=</span> <span class="n">dtm_10_</span> <span class="o">+</span> <span class="n">xdem</span><span class="p">.</span><span class="nc">DEM</span><span class="p">(</span><span class="sh">'</span><span class="s">no_kv_HREF2018B_NN2000_EUREF89.tif</span><span class="sh">'</span><span class="p">).</span><span class="nf">reproject</span><span class="p">(</span><span class="n">dtm_10_</span><span class="p">,</span><span class="n">resampling</span><span class="o">=</span><span class="sh">'</span><span class="s">bilinear</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># 3 DTM 1 exmaple (1 m Norway DTM-1)
</span><span class="n">fid_dtm1</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">\\hypatia.uio.no\lh-mn-geofag-felles\projects\snowdepth\data\DEM\Norway\DTM1_11-11_UTM33\33-112-114.tif</span><span class="sh">'</span>
<span class="n">dtm_1_</span> <span class="o">=</span> <span class="n">xdem</span><span class="p">.</span><span class="nc">DEM</span><span class="p">(</span><span class="n">fid_dtm1</span><span class="p">).</span><span class="nf">reproject</span><span class="p">(</span><span class="n">dst_crs</span><span class="o">=</span><span class="n">pyproj</span><span class="p">.</span><span class="nc">CRS</span><span class="p">(</span><span class="mi">32633</span><span class="p">),</span><span class="n">dst_res</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">dtm_1</span> <span class="o">=</span> <span class="n">dtm_1_</span> <span class="o">+</span> <span class="n">xdem</span><span class="p">.</span><span class="nc">DEM</span><span class="p">(</span><span class="sh">'</span><span class="s">no_kv_HREF2018B_NN2000_EUREF89.tif</span><span class="sh">'</span><span class="p">).</span><span class="nf">reproject</span><span class="p">(</span><span class="n">dtm_1_</span><span class="p">,</span><span class="n">resampling</span><span class="o">=</span><span class="sh">'</span><span class="s">bilinear</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># subset snow free measurements
</span><span class="kn">from</span> <span class="n">xsnow.godh</span> <span class="kn">import</span> <span class="n">load_gdf</span>
<span class="n">sf_subset_dtm10</span> <span class="o">=</span> <span class="nf">load_gdf</span><span class="p">(</span><span class="n">sf_gdf</span><span class="p">,</span><span class="n">dtm_10</span><span class="p">,</span><span class="n">z_name</span><span class="o">=</span><span class="sh">'</span><span class="s">h_te_best_fit</span><span class="sh">'</span><span class="p">)</span>
<span class="n">sf_subset_dtm1</span> <span class="o">=</span> <span class="nf">load_gdf</span><span class="p">(</span><span class="n">sf_gdf</span><span class="p">,</span><span class="n">dtm_1</span><span class="p">,</span><span class="n">z_name</span><span class="o">=</span><span class="sh">'</span><span class="s">h_te_best_fit</span><span class="sh">'</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">The length of sf_subset_dtm10: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">sf_subset_dtm10</span><span class="p">)</span><span class="si">}</span><span class="s"> points</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">The length of sf_subset_dtm1: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">sf_subset_dtm1</span><span class="p">)</span><span class="si">}</span><span class="s"> points</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The length of sf_subset_dtm10: 20291 points
The length of sf_subset_dtm1: 1113 points
</code></pre></div></div> <h3 id="the-main-challenges-of-applying-nuthkaab-coreg-on-icesat-2">The main challenges of applying NuthKaab coreg on ICESat-2</h3> <p>NuthKaab estimates the â€˜shift matrixâ€™ iteratively by solving a cosine equation that models the direction in which the DEM is most likely offset.</p> <ul> <li>(1) However, this process requires the calculation of â€˜slopeâ€™, â€˜aspectâ€™, and â€˜curvatureâ€™, which can be time-consuming and resource-intensive, especially if the DEM has a fine resolution. In fact, the computational cost of NuthKaab coregistration grows exponentially as the resolution of the DEM increases.</li> <li>(2) In addition, NuthKaab is a statistical method that requires a large sample of points (e.g. at least 1000-2000) to work accurately. If there are too few points available in the ICESat-2 dataset (which is often the case with fine DEMs), NuthKaab may not work properly or may produce incorrect results.</li> </ul> <p>Below, I have provided three examples to illustrate these challenges.</p> <ul> <li>(a) NuthKaab coregistration works well on a normal DEM with sufficient points.</li> <li>(b) NuthKaab takes longer and produces incorrect results on a fine DEM with fewer points.</li> <li>(c) NuthKaab fails completely when there are not enough points (e.g. less than 500).</li> </ul> <h4 id="nuthkaab-coreg">NuthKaab Coreg</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>

<span class="c1"># (a) NuthKaab Coreg examples of DTM10. It works well on normal DEMs.
</span><span class="n">results_nk_10</span> <span class="o">=</span> <span class="nf">get_dh_dem</span><span class="p">(</span><span class="n">dtm_10</span><span class="p">,</span><span class="n">sf_subset_dtm10</span><span class="p">,</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">perc_t</span><span class="o">=</span><span class="mf">99.75</span><span class="p">,</span><span class="n">std_t</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">mask_highcurv</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Warning: There is no curvature in dataframe. Set mask_highcurv = True for more robust results and costs more time
CPU times: total: 35.3 s
Wall time: 35.3 s
</code></pre></div></div> <p><img src="https://zhihaol.eu.org/assets/img/notebook/2023-01-05-GradientDescendingCoreg/2023-01-05-GradientDescendingCoreg_4_1.png" alt="png" class="center-image"></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>

<span class="c1"># NuthKaab example on DTM1, it consumes more time on DTM1, and bad coreg due to sample size.
</span><span class="n">result_nk_1</span> <span class="o">=</span> <span class="nf">get_dh_dem</span><span class="p">(</span><span class="n">dtm_1</span><span class="p">,</span> <span class="n">sf_subset_dtm1</span><span class="p">,</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">perc_t</span><span class="o">=</span><span class="mf">99.75</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mask_highcurv</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># The STD, RMSE, NMAD do not improve after NuthKaab Coreg.
# Even the bias is not relieable becasue the samll sample size.
</span></code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Warning: There is no curvature in dataframe. Set mask_highcurv = True for more robust results and costs more time
CPU times: total: 5min 58s
Wall time: 5min 58s
</code></pre></div></div> <p><img src="https://zhihaol.eu.org/assets/img/notebook/2023-01-05-GradientDescendingCoreg/2023-01-05-GradientDescendingCoreg_5_1.png" alt="png" class="center-image"></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="c1"># NuthKaab fail due to sample size. Here I downsampling to 500 points.
</span>
<span class="n">result</span> <span class="o">=</span> <span class="nf">get_dh_dem</span><span class="p">(</span><span class="n">dtm_1</span><span class="p">,</span> <span class="n">sf_subset_dtm1</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">500</span><span class="o">/</span><span class="nf">len</span><span class="p">(</span><span class="n">sf_subset_dtm1</span><span class="p">)),</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">perc_t</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mask_highcurv</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Running Nuth and KÃ¤Ã¤b (2011) coregistration.
   Calculate slope and aspect
   Statistics on initial dh:
      Median = -0.117 - NMAD = 0.795
   Iteratively estimating horizontal shit:

   Progress:   0%|          | 0/10 [00:00&lt;?, ?it/s]


---------------------------------------------------------------------------

ValueError                                Traceback (most recent call last)

File &lt;timed exec&gt;:3, in &lt;module&gt;


ValueError: Less than 10 different cells exist.
</code></pre></div></div> <h4 id="gradient-descending-coreg">Gradient Descending Coreg</h4> <p>Gradient descent is an optimization algorithm commonly used in machine learning and data science to find the minimum of a function. It works by iteratively adjusting the parameters of the function in the direction that minimizes the output value. Here the values are the offset of the DEM, or the â€˜shift matrixâ€™.</p> <p>It works like going down from the top of the mountain.</p> <ul> <li>Check the surrounding.</li> <li>Calculate the slope (gradient) on each direction. Here the elevation is the loss function.</li> <li>Do adjustment (going downhill) according to your pace (learning rate).</li> <li>Iterate.</li> <li>Reach the minimum of a function.</li> </ul> <p>We run three examples again by Gradient Descending Coreg, <strong>being mind of the time.</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>

<span class="c1"># (a) DTM 10.
</span><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Comparision on DTM10</span><span class="sh">'</span><span class="p">)</span>

<span class="c1">## gradient descending coreg
</span><span class="n">results_10</span> <span class="o">=</span> <span class="nf">best_shift_px</span><span class="p">(</span><span class="n">dtm_10</span><span class="p">,</span><span class="n">sf_subset_dtm10</span><span class="p">,</span><span class="n">disp</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">stat</span><span class="o">=</span><span class="sh">'</span><span class="s">mix</span><span class="sh">'</span><span class="p">,</span><span class="n">perc_t</span><span class="o">=</span><span class="mi">99</span><span class="p">,</span><span class="n">downsampling</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1">## get dh using parameters from gradient descending coreg
</span><span class="n">pts_10</span> <span class="o">=</span> <span class="nf">get_dh_by_shift_px_gdf</span><span class="p">(</span><span class="n">dtm_10</span><span class="p">,</span><span class="n">sf_subset_dtm10</span><span class="p">,(</span><span class="n">results_10</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">results_10</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">results_10</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">stat</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1">## plot
</span><span class="nf">final_histogram</span><span class="p">(</span><span class="n">results_nk_10</span><span class="p">[</span><span class="sh">'</span><span class="s">gdf</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">dh_after</span><span class="sh">'</span><span class="p">],</span><span class="n">pts_10</span><span class="p">[</span><span class="sh">'</span><span class="s">dh</span><span class="sh">'</span><span class="p">],</span><span class="n">dH_ref</span><span class="o">=</span><span class="n">results_nk_10</span><span class="p">[</span><span class="sh">'</span><span class="s">gdf</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">dh_before</span><span class="sh">'</span><span class="p">],</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">perc_t</span><span class="o">=</span><span class="mf">99.5</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">NuthKaab Coreg</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Gradient Descending Coreg</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">raw</span><span class="sh">'</span><span class="p">]);</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">NuthKaab Coreg fit matrix(e_px,n_px,bias),nmad:</span><span class="sh">'</span><span class="p">,</span><span class="n">results_nk_10</span><span class="p">[</span><span class="sh">'</span><span class="s">shift_matrix</span><span class="sh">'</span><span class="p">],</span><span class="n">results_nk_10</span><span class="p">[</span><span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">nmad_after</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Comparision on DTM10
Gradient Descending Coreg fit matrix(e_px,n_px,bias),nmad:(-0.5000,0.3906,0.1385),0.3243
NuthKaab Coreg fit matrix(e_px,n_px,bias),nmad: (-0.47167920355557263, 0.3644381456590511, 0.137939453125) 0.32735018920898434
CPU times: total: 9.84 s
Wall time: 9.84 s
</code></pre></div></div> <p><img src="https://zhihaol.eu.org/assets/img/notebook/2023-01-05-GradientDescendingCoreg/2023-01-05-GradientDescendingCoreg_8_1.png" alt="png" class="center-image"></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>

<span class="c1"># (b) DTM 1
</span><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Comparision on DTM1</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">## gradient descending coreg
</span><span class="n">results_1</span> <span class="o">=</span> <span class="nf">best_shift_px</span><span class="p">(</span><span class="n">dtm_1</span><span class="p">,</span><span class="n">sf_subset_dtm1</span><span class="p">,</span><span class="n">disp</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">stat</span><span class="o">=</span><span class="sh">'</span><span class="s">mix</span><span class="sh">'</span><span class="p">,</span><span class="n">perc_t</span><span class="o">=</span><span class="mf">99.5</span><span class="p">)</span>

<span class="c1">## using parameters from gradient descending coreg. No bias correction.
</span><span class="n">pts_1</span> <span class="o">=</span> <span class="nf">get_dh_by_shift_px_gdf</span><span class="p">(</span><span class="n">dtm_1</span><span class="p">,</span><span class="n">sf_subset_dtm1</span><span class="p">,(</span><span class="n">results_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">results_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="mi">0</span><span class="p">,</span><span class="n">stat</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1">## plot in comparison with NuthKaab Coreg
</span><span class="nf">final_histogram</span><span class="p">(</span><span class="n">result_nk_1</span><span class="p">[</span><span class="sh">'</span><span class="s">gdf</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">dh_after</span><span class="sh">'</span><span class="p">]</span><span class="o">+</span><span class="n">results_1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">pts_1</span><span class="p">[</span><span class="sh">'</span><span class="s">dh</span><span class="sh">'</span><span class="p">],</span><span class="n">dH_ref</span><span class="o">=</span><span class="n">result_nk_1</span><span class="p">[</span><span class="sh">'</span><span class="s">gdf</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">dh_before</span><span class="sh">'</span><span class="p">],</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">bins</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span><span class="n">perc_t</span><span class="o">=</span><span class="mf">99.5</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">NuthKaab Coreg</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Gradient Descending Coreg</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">raw</span><span class="sh">'</span><span class="p">]);</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">NuthKaab Coreg fit matrix(e_px,n_px,bias),nmad:</span><span class="sh">'</span><span class="p">,</span><span class="n">result_nk_1</span><span class="p">[</span><span class="sh">'</span><span class="s">shift_matrix</span><span class="sh">'</span><span class="p">],</span><span class="n">result_nk_1</span><span class="p">[</span><span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">nmad_after</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Comparision on DTM1
Gradient Descending Coreg fit matrix(e_px,n_px,bias),nmad:(-0.8750,-1.2284,-0.1682),0.7210
NuthKaab Coreg fit matrix(e_px,n_px,bias),nmad: (-0.3431186328204423, -1.0512761859101158, -0.169189453125) 0.7765913818359375
CPU times: total: 641 ms
Wall time: 626 ms
</code></pre></div></div> <p><img src="https://zhihaol.eu.org/assets/img/notebook/2023-01-05-GradientDescendingCoreg/2023-01-05-GradientDescendingCoreg_9_1.png" alt="png" class="center-image"></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>

<span class="c1"># (c) DTM 1 with only 500 points
</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Comparision on DTM1 - 500 points challenge</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">## gradient descending coreg
</span><span class="n">results_500</span> <span class="o">=</span> <span class="nf">best_shift_px</span><span class="p">(</span><span class="n">dtm_1</span><span class="p">,</span><span class="n">sf_subset_dtm1</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1000</span><span class="o">/</span><span class="nf">len</span><span class="p">(</span><span class="n">sf_subset_dtm1</span><span class="p">)),</span><span class="n">disp</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">stat</span><span class="o">=</span><span class="sh">'</span><span class="s">mix</span><span class="sh">'</span><span class="p">,</span><span class="n">perc_t</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>

<span class="c1">## get dh using parameters from gradient descending coreg
</span><span class="n">pts_500</span> <span class="o">=</span> <span class="nf">get_dh_by_shift_px_gdf</span><span class="p">(</span><span class="n">dtm_1</span><span class="p">,</span><span class="n">sf_subset_dtm1</span><span class="p">,(</span><span class="n">results_500</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">results_500</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="mi">0</span><span class="p">,</span><span class="n">stat</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1">## plot in comparison with (b)
</span><span class="nf">final_histogram</span><span class="p">(</span><span class="n">pts_1</span><span class="p">[</span><span class="sh">'</span><span class="s">dh</span><span class="sh">'</span><span class="p">],</span><span class="n">pts_500</span><span class="p">[</span><span class="sh">'</span><span class="s">dh</span><span class="sh">'</span><span class="p">],</span><span class="n">dH_ref</span><span class="o">=</span><span class="n">result_nk_1</span><span class="p">[</span><span class="sh">'</span><span class="s">gdf</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">dh_before</span><span class="sh">'</span><span class="p">],</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">perc_t</span><span class="o">=</span><span class="mf">99.5</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">GD Coreg</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">GD Coreg (500 pts)</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">raw</span><span class="sh">'</span><span class="p">]);</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">NuthKaab Coreg fit matrix(e_px,n_px,bias),nmad: Fail to coreg</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Comparision on DTM1 - 500 points challenge
Gradient Descending Coreg fit matrix(e_px,n_px,bias),nmad:(-1.0000,-0.2374,-0.1486),0.7371
NuthKaab Coreg fit matrix(e_px,n_px,bias),nmad: Fail to coreg
CPU times: total: 781 ms
Wall time: 779 ms
</code></pre></div></div> <p><img src="https://zhihaol.eu.org/assets/img/notebook/2023-01-05-GradientDescendingCoreg/2023-01-05-GradientDescendingCoreg_10_1.png" alt="png" class="center-image"></p> <h4 id="section-summary">Section summary</h4> <p>â€˜Gradient Descending Coregistrationâ€™ is a point-based coregistration method that <strong>is significantly fast (in seconds) and efficient regardless of the resolution of the DEM</strong>. It is also able to handle datasets with a small number of points, unlike NuthKaab coregistration which requires a large sample size to work accurately.</p> <p>In addition to using NMAD, my â€˜Gradient Descending Coregistrationâ€™ method <strong>also incorporates RMSE to make the coregistration process more â€˜sensitiveâ€™ to â€˜shiftsâ€™. In contrast, xDEM only uses NMAD,</strong> which may not always give the optimal offset but explained the difference in previous examples.</p> <ul> <li>However, it is important to carefully choose the hyperparameters, particularly the learning rate, to ensure that the algorithm can find the global minimum of the function.</li> <li>It is also worth noting that the results of â€˜Gradient Descending Coregistrationâ€™ may vary depending on the local minima reached, particularly when sample size are less than 1000 points.</li> <li>Finally, for datasets with a very large number of points (e.g. over 50000), I recommend using NuthKaab coregistration, which is very robust in these scenarios.</li> </ul> <h2 id="not-just-icesat-2">Not just ICESat-2</h2> <p>In addition to being effective for co-registering DEMs with points, <strong>â€˜Gradient Descending Coregistrationâ€™ also performs well for normal DEM coregistration.</strong></p> <p>To compare the speed and accuracy, we will use two different datasets: (1) a known shifted DTM10, and (2) Arctic DEM and DTM1.</p> <ul> <li>(a) xdem.NuthKaab</li> <li>(b) Gradient Descending Coreg</li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">xsnow.godh</span> <span class="kn">import</span> <span class="n">dem_difference_plot</span>
<span class="kn">from</span> <span class="n">xsnow.misc</span> <span class="kn">import</span> <span class="n">dem_shift</span>
<span class="kn">import</span> <span class="n">xdem</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Shift a DTM10 (1.2,-0.7) px and 0.16 m on purpose
</span><span class="n">dtm_10_shifted</span> <span class="o">=</span> <span class="nf">dem_shift</span><span class="p">(</span><span class="n">dtm_10</span><span class="p">,</span><span class="mf">1.2</span><span class="p">,</span><span class="o">-</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.16</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot. dh resembles to terrain.
</span><span class="n">ddem</span> <span class="o">=</span> <span class="n">dtm_10_shifted</span> <span class="o">-</span> <span class="n">dtm_10</span>
<span class="n">ddem</span><span class="p">.</span><span class="nf">show</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div> <p><img src="https://zhihaol.eu.org/assets/img/notebook/2023-01-05-GradientDescendingCoreg/2023-01-05-GradientDescendingCoreg_21_0.png" alt="png" class="center-image"></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>

<span class="c1"># a. NuthKaab Coreg on DEM and shifted DEM
</span>
<span class="n">func</span> <span class="o">=</span> <span class="n">xdem</span><span class="p">.</span><span class="n">coreg</span><span class="p">.</span><span class="nc">NuthKaab</span><span class="p">()</span>
<span class="n">func</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">dtm_10</span><span class="p">,</span><span class="n">dtm_10_shifted</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Coreg maxtrix east_px, north_px, bias:</span><span class="si">{</span><span class="n">func</span><span class="p">.</span><span class="n">_meta</span><span class="p">[</span><span class="sh">"</span><span class="s">offset_east_px</span><span class="sh">"</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">,</span><span class="si">{</span><span class="n">func</span><span class="p">.</span><span class="n">_meta</span><span class="p">[</span><span class="sh">"</span><span class="s">offset_north_px</span><span class="sh">"</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">,</span><span class="si">{</span><span class="n">func</span><span class="p">.</span><span class="n">_meta</span><span class="p">[</span><span class="sh">"</span><span class="s">bias</span><span class="sh">"</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Coreg maxtrix east_px, north_px, bias:-1.2199,0.7108,-0.160
CPU times: total: 1min
Wall time: 1min
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="c1"># b. Gradient descending Coreg on DEM and shifted DEM
</span>
<span class="c1"># sampling points from DEM
</span><span class="n">df</span> <span class="o">=</span> <span class="nf">df_from_dem</span><span class="p">(</span><span class="n">dtm_10</span><span class="p">,</span><span class="n">samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>

<span class="c1"># runing gradient descening coreg on sampling points
</span><span class="nf">best_shift_px</span><span class="p">(</span><span class="n">dtm_10_shifted</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">x0</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">footprint</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">z_name</span><span class="o">=</span><span class="sh">'</span><span class="s">z</span><span class="sh">'</span><span class="p">,</span><span class="n">disp</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">stat</span><span class="o">=</span><span class="sh">'</span><span class="s">nmad</span><span class="sh">'</span><span class="p">,</span><span class="n">downsampling</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Gradient Descending Coreg fit matrix(e_px,n_px,bias),nmad:(-1.1935,0.7031,-0.1600),0.0691
CPU times: total: 1.12 s
Wall time: 1.09 s


(-1.1935, 0.703125, -0.16000366, 0.06911228942871094)
</code></pre></div></div> <p>The examples indicate that time reducing <strong>from 1 minutes to 1 seconds!</strong> It could be from 14 minutes to 5 seconds. Now lets looks at some real datasets. Co-registering <strong>Arctic DEM and DTM1</strong>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## DTM1 
</span><span class="n">fid_dtm1</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">\\hypatia.uio.no\lh-mn-geofag-felles\projects\snowdepth\data\DEM\Norway\DTM1_11-11_UTM33\33-113-119.tif</span><span class="sh">'</span>
<span class="n">dtm1</span> <span class="o">=</span> <span class="n">xdem</span><span class="p">.</span><span class="nc">DEM</span><span class="p">(</span><span class="n">fid_dtm1</span><span class="p">).</span><span class="nf">reproject</span><span class="p">(</span><span class="n">dst_crs</span><span class="o">=</span><span class="n">pyproj</span><span class="p">.</span><span class="nc">CRS</span><span class="p">(</span><span class="mi">32633</span><span class="p">),</span><span class="n">dst_res</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<span class="n">grid_nn2000</span> <span class="o">=</span> <span class="n">xdem</span><span class="p">.</span><span class="nc">DEM</span><span class="p">(</span><span class="sh">'</span><span class="s">no_kv_HREF2018B_NN2000_EUREF89.tif</span><span class="sh">'</span><span class="p">)</span>
<span class="n">dtm_1_ref</span> <span class="o">=</span> <span class="n">dtm1</span> <span class="o">+</span> <span class="n">grid_nn2000</span><span class="p">.</span><span class="nf">reproject</span><span class="p">(</span><span class="n">dtm1</span><span class="p">,</span><span class="n">resampling</span><span class="o">=</span><span class="sh">'</span><span class="s">bilinear</span><span class="sh">'</span><span class="p">)</span>

<span class="c1">## Arctic DEM and reproject to DTM1
</span><span class="n">fid_arctic</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">\\hypatia.uio.no\lh-mn-geofag-felles\projects\snowdepth\data\DEM\Norway\ArcticDEM\21_67_1_1_2m_v3.0\21_67_1_1_2m_v3.0_reg_dem.tif</span><span class="sh">'</span>
<span class="n">dtm_arctic</span> <span class="o">=</span> <span class="n">xdem</span><span class="p">.</span><span class="nc">DEM</span><span class="p">(</span><span class="n">fid_arctic</span><span class="p">).</span><span class="nf">reproject</span><span class="p">(</span><span class="n">dtm1</span><span class="p">)</span>

</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>

<span class="c1"># a. NuthKaab Coreg. Work on 1m resolution.
</span>
<span class="n">func</span> <span class="o">=</span> <span class="n">xdem</span><span class="p">.</span><span class="n">coreg</span><span class="p">.</span><span class="nc">NuthKaab</span><span class="p">()</span>
<span class="n">func</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">dtm_1_ref</span><span class="p">,</span><span class="n">dtm_arctic</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Coreg maxtrix east_px, north_px, bias:</span><span class="si">{</span><span class="n">func</span><span class="p">.</span><span class="n">_meta</span><span class="p">[</span><span class="sh">"</span><span class="s">offset_east_px</span><span class="sh">"</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">,</span><span class="si">{</span><span class="n">func</span><span class="p">.</span><span class="n">_meta</span><span class="p">[</span><span class="sh">"</span><span class="s">offset_north_px</span><span class="sh">"</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">,</span><span class="si">{</span><span class="n">func</span><span class="p">.</span><span class="n">_meta</span><span class="p">[</span><span class="sh">"</span><span class="s">bias</span><span class="sh">"</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Coreg maxtrix east_px, north_px, bias:5.1641,-4.1300,-0.555
CPU times: total: 14min 4s
Wall time: 14min 4s
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>
<span class="c1"># b. Gradient descending Coreg. Work on 1m resolution.
</span>
<span class="c1"># sampling points from DEM_Ref
</span><span class="n">df_ref</span> <span class="o">=</span> <span class="nf">df_from_dem</span><span class="p">(</span><span class="n">dtm_1_ref</span><span class="p">,</span><span class="n">samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>

<span class="c1"># runing gradient descening coreg on sampling points
</span><span class="n">res_gd</span> <span class="o">=</span><span class="nf">best_shift_px</span><span class="p">(</span><span class="n">dtm_arctic</span><span class="p">,</span><span class="n">df_ref</span><span class="p">,</span><span class="n">x0</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">footprint</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">z_name</span><span class="o">=</span><span class="sh">'</span><span class="s">z</span><span class="sh">'</span><span class="p">,</span><span class="n">disp</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">stat</span><span class="o">=</span><span class="sh">'</span><span class="s">mix</span><span class="sh">'</span><span class="p">,</span><span class="n">downsampling</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">perc_t</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Gradient Descending Coreg fit matrix(e_px,n_px,bias),nmad:(2.7500,-3.4922,-0.5269),0.9925
CPU times: total: 5.25 s
Wall time: 5.25 s
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="c1"># ddem
</span><span class="n">ddem_raw</span> <span class="o">=</span> <span class="n">dtm_arctic</span> <span class="o">-</span> <span class="n">dtm_1_ref</span>
<span class="n">ddem_coreg_nuthkaab</span> <span class="o">=</span> <span class="nf">dem_shift</span><span class="p">(</span><span class="n">dtm_arctic</span><span class="p">,</span><span class="mf">5.1641</span><span class="p">,</span><span class="o">-</span><span class="mf">4.13</span><span class="p">,</span><span class="o">-</span><span class="mf">0.555</span><span class="p">)</span> <span class="o">-</span> <span class="n">dtm_1_ref</span>
<span class="n">ddem_coreg_gd</span> <span class="o">=</span> <span class="nf">dem_shift</span><span class="p">(</span><span class="n">dtm_arctic</span><span class="p">,</span><span class="mf">2.7500</span><span class="p">,</span><span class="o">-</span><span class="mf">3.4922</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5269</span><span class="p">)</span> <span class="o">-</span> <span class="n">dtm_1_ref</span>

<span class="c1"># plot
</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
<span class="n">ddem_coreg_nuthkaab</span><span class="p">.</span><span class="nf">show</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span><span class="n">cb_title</span><span class="o">=</span><span class="sh">'</span><span class="s">dH (m)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ddem_coreg_gd</span><span class="p">.</span><span class="nf">show</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>

<span class="n">ax1</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">dH (coreg_nuthkaab)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax2</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">dH (coreg_gradient_descending)</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">final_histogram</span><span class="p">(</span><span class="n">ddem_coreg_nuthkaab</span><span class="p">,</span><span class="n">ddem_coreg_gd</span><span class="p">,</span><span class="n">dH_ref</span><span class="o">=</span><span class="n">ddem_raw</span><span class="p">,</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">NuthKaab</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">GradientDescending</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">raw</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div> <p><img src="https://zhihaol.eu.org/assets/img/notebook/2023-01-05-GradientDescendingCoreg/2023-01-05-GradientDescendingCoreg_28_1.png" alt="png" class="center-image"></p> <h4 id="section-summary-1">Section Summary</h4> <p>Arctic DEM in this area (close to Finse) is a snow-on DEM. So, there is no reason to do bias correction e.g. -0.555 m or -0.5269 m (This is snow depth over the entire area acrtually). For the same reason, snow cover introduce errors that make it challenging to obtain reliable co-registration results. In this competition.</p> <ul> <li>NuthKaab give a shift matrix (5.1641,-4.13) with NMAD 1.03 m in 14 minutes</li> <li>Gradiant Descending Corg give a shift matrix (2.7500,-3.4922) with NMAD 1.01 m in just 5 seconds.</li> </ul> <p>Based on these results, we conclude that â€˜Gradient Descending Coregistrationâ€™ is the superior method in all scenarios. Additionally, â€˜Gradient Descending Coregistrationâ€™ can easily support rotation correction, making it even more versatile.</p> <h2 id="point-interpolation-vs-zonal-statistics-of-the-footprint">Point interpolation vs Zonal statistics of the footprint</h2> <p>When picking up a value at a point on a DEM, the value may not match the grid exactly and instead is an <strong>interpolated value</strong>.</p> <p>In xDEM, interpolation is implemented using scipy.ndimapge.map_coordinates, which supports nearest, bilinear, and bicubic interpolation. Bicubic interpolation is sometimes better than bilinear interpolation, but this is not always the case.</p> <p>Another option for evaluating the value at a point on a DEM is to use <strong>zonal statistics</strong>, which calculates a statistic (e.g. mean, median, etc.) for the area surrounding the point. This can be particularly useful for high-resolution DEMs, where the statistic value of the footprint may provide a more accurate representation of the true value because the statistics removed the noisy spikes.</p> <p><strong>So, What is the best footprint size for zonal statistics? Again, I used gradient descending to find it!</strong></p> <p>I will use DTM1 and ICESat-2 snow-free measurements as an example to demonstrate the difference of two methods.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># The footprint of ICESat-2 is about 13 m by 13 m.
</span><span class="n">pts_size</span> <span class="o">=</span> <span class="nf">get_dh_by_footprint</span><span class="p">(</span><span class="n">dtm_1</span><span class="p">,</span> <span class="n">sf_subset_dtm1</span><span class="p">,(</span><span class="mi">13</span><span class="p">,</span><span class="mi">13</span><span class="p">),</span><span class="n">z_name</span><span class="o">=</span><span class="sh">'</span><span class="s">h_te_best_fit</span><span class="sh">'</span><span class="p">,</span><span class="n">s_name</span><span class="o">=</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">,</span><span class="n">stat</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">perc_t</span><span class="o">=</span><span class="mf">99.75</span><span class="p">)</span>

<span class="c1">## plot
</span><span class="nf">final_histogram</span><span class="p">(</span><span class="n">pts_1</span><span class="p">[</span><span class="sh">'</span><span class="s">dh</span><span class="sh">'</span><span class="p">],</span><span class="n">pts_size</span><span class="p">[</span><span class="sh">'</span><span class="s">dh</span><span class="sh">'</span><span class="p">],</span><span class="n">dH_ref</span><span class="o">=</span><span class="n">result_nk_1</span><span class="p">[</span><span class="sh">'</span><span class="s">gdf</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">dh_before</span><span class="sh">'</span><span class="p">],</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">perc_t</span><span class="o">=</span><span class="mf">99.75</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">GD Coreg</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">footprint 13*13</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">raw</span><span class="sh">'</span><span class="p">]);</span>

</code></pre></div></div> <p><img src="https://zhihaol.eu.org/assets/img/notebook/2023-01-05-GradientDescendingCoreg/2023-01-05-GradientDescendingCoreg_13_0.png" alt="png" class="center-image"></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Gradient Descending suggest the better size
</span><span class="n">size</span> <span class="o">=</span> <span class="nf">best_footprint</span><span class="p">(</span><span class="n">dtm_1</span><span class="p">,</span> <span class="n">sf_subset_dtm1</span><span class="p">,(</span><span class="mi">13</span><span class="p">,</span><span class="mi">13</span><span class="p">),</span><span class="n">z_name</span><span class="o">=</span><span class="sh">'</span><span class="s">h_te_best_fit</span><span class="sh">'</span><span class="p">,</span><span class="n">s_name</span><span class="o">=</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">,</span><span class="n">stat</span><span class="o">=</span><span class="sh">'</span><span class="s">mix</span><span class="sh">'</span><span class="p">,</span><span class="n">perc_t</span><span class="o">=</span><span class="mf">99.75</span><span class="p">)</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>the best fit footprint(width,length): (8.0000,25.1250)
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Use the 'best' size to get elevation difference
</span><span class="n">pts_size</span> <span class="o">=</span> <span class="nf">get_dh_by_footprint</span><span class="p">(</span><span class="n">dtm_1</span><span class="p">,</span> <span class="n">sf_subset_dtm1</span><span class="p">,(</span><span class="mi">8</span><span class="p">,</span><span class="mf">25.125</span><span class="p">),</span><span class="n">z_name</span><span class="o">=</span><span class="sh">'</span><span class="s">h_te_best_fit</span><span class="sh">'</span><span class="p">,</span><span class="n">s_name</span><span class="o">=</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">,</span><span class="n">stat</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">perc_t</span><span class="o">=</span><span class="mf">99.75</span><span class="p">)</span>

<span class="c1">## plot
</span><span class="nf">final_histogram</span><span class="p">(</span><span class="n">pts_1</span><span class="p">[</span><span class="sh">'</span><span class="s">dh</span><span class="sh">'</span><span class="p">],</span><span class="n">pts_size</span><span class="p">[</span><span class="sh">'</span><span class="s">dh</span><span class="sh">'</span><span class="p">],</span><span class="n">dH_ref</span><span class="o">=</span><span class="n">result_nk_1</span><span class="p">[</span><span class="sh">'</span><span class="s">gdf</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">dh_before</span><span class="sh">'</span><span class="p">],</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">perc_t</span><span class="o">=</span><span class="mf">99.75</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">GD Coreg</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">footprint 8*25</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">raw</span><span class="sh">'</span><span class="p">]);</span>

</code></pre></div></div> <p><img src="https://zhihaol.eu.org/assets/img/notebook/2023-01-05-GradientDescendingCoreg/2023-01-05-GradientDescendingCoreg_15_0.png" alt="png" class="center-image"></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Use the size to get elevation difference
</span><span class="n">pts_13100</span> <span class="o">=</span> <span class="nf">get_dh_by_footprint</span><span class="p">(</span><span class="n">dtm_1</span><span class="p">,</span> <span class="n">sf_subset_dtm1</span><span class="p">,(</span><span class="mi">13</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span><span class="n">z_name</span><span class="o">=</span><span class="sh">'</span><span class="s">h_te_best_fit</span><span class="sh">'</span><span class="p">,</span><span class="n">s_name</span><span class="o">=</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">,</span><span class="n">stat</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">perc_t</span><span class="o">=</span><span class="mf">99.75</span><span class="p">)</span>

<span class="c1">## plot
</span><span class="nf">final_histogram</span><span class="p">(</span><span class="n">pts_13100</span><span class="p">[</span><span class="sh">'</span><span class="s">dh</span><span class="sh">'</span><span class="p">],</span><span class="n">pts_size</span><span class="p">[</span><span class="sh">'</span><span class="s">dh</span><span class="sh">'</span><span class="p">],</span><span class="n">dH_ref</span><span class="o">=</span><span class="n">result_nk_1</span><span class="p">[</span><span class="sh">'</span><span class="s">gdf</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">dh_before</span><span class="sh">'</span><span class="p">],</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">perc_t</span><span class="o">=</span><span class="mf">99.75</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">footprint 13*100</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">footprint 8*25</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">raw</span><span class="sh">'</span><span class="p">]);</span>

</code></pre></div></div> <p><img src="https://zhihaol.eu.org/assets/img/notebook/2023-01-05-GradientDescendingCoreg/2023-01-05-GradientDescendingCoreg_16_0.png" alt="png" class="center-image"></p> <h4 id="section-summary-2">Section Summary</h4> <p>It is controversial to decide which one to use, point interpolation (with coreg) <strong>or</strong> footprint zonal statistics. So far we have matched ICESat-2 â€˜s h_te_bestfit with values from:</p> <ul> <li>interpolation (and coreg) with NMAD 0.72 m.</li> <li>foorprint 13x13 m with NMAD 0.75 m (the footprint size naturally)</li> <li>foorprint 8x25 m with NMAD 0.67 m (the best footprint suggest by gradient descending algorithm)</li> <li>foorprint 13x100 m with NMAD 1.20 m (the footprint size of ATL08 segment)</li> </ul> <p>However, the results are hard to be reliable due to the small sample size. But gradient descending is very useful for applications on DEM or ICESat-2 dataset.</p> </article> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container"> Â© Copyright 2023 Zhihao LIU. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>